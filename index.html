<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meus Produtos 🐱💕</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Pacifico&display=swap" rel="stylesheet">
  <!-- CSS principal -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- INTRO OVERLAY COM PATINHA -->
  <div id="intro-overlay">
    <div class="intro-cat">
      <span class="paw-emoji">🐾</span>
    </div>
  </div>

  <!-- HEADER CENTRALIZADO -->
  <header>
    <div class="header-inner">
      <div class="logo-container">
        <h1 class="glitter-title">🐱 Meus Produtos 🐱</h1>
        <span class="emoji">💕</span>
      </div>
      <button id="btn-novo" class="btn-primary">+ Novo Produto</button>
    </div>
  </header>

  <!-- CONTAINER CENTRAL (CONTÉM RESUMO, TABELA E CARDS MOBILE) -->
  <div class="container">
    <!-- RESUMO EM CARDS -->
    <section id="resumo">
      <div class="resumo-item">
        <span class="label">Perto de vencer:</span>
        <span id="avisoVencendo">0</span>
      </div>
      <div class="resumo-item">
        <span class="label">Vencidos:</span>
        <span id="avisoVencido">0</span>
      </div>
    </section>

    <!-- TABELA (DESKTOP) -->
    <div class="table-wrapper">
      <table id="tabela-produtos">
        <thead>
          <tr>
            <th>🐾 Nome</th>
            <th>🐾 Qtd.</th>
            <th>🐾 Validade</th>
            <th>🐾 Status</th>
            <th>🐾 Ações</th>
          </tr>
        </thead>
        <tbody>
          <!-- Linhas geradas dinamicamente pelo JS -->
        </tbody>
      </table>
    </div>

    <!-- LISTA DE CARDS (MOBILE) -->
    <div class="mobile-card-list"></div>
  </div>

  <!-- RODAPÉ -->
  <footer>
    <p>Feito com 💖 para você</p>
  </footer>

  <!-- SCRIPT: CRUD, INTRO, GLITTER, CLICK PAW, CARDS MOBILE, ETC. -->
  <script>
    // 1) INTRO OVERLAY
    document.addEventListener("DOMContentLoaded", () => {
      const overlay = document.getElementById("intro-overlay");
      const paw = document.querySelector(".intro-cat");
      if (paw) {
        paw.classList.add("cat-bounce");
        setTimeout(() => {
          overlay.classList.add("fade-out");
        }, 2000);
        overlay.addEventListener("animationend", e => {
          if (e.animationName === "fadeOutOverlay") {
            overlay.style.display = "none";
            iniciarApp();
          }
        });
      } else {
        iniciarApp();
      }

      // 7) CLICK PAW EM QUALQUER LUGAR (exceto botões)
      document.body.addEventListener("click", e => {
        spawnClickPaw(e);
      });
    });

    // 2) INICIA A APLICAÇÃO
    function iniciarApp() {
      montarTabela();
      gerarGlitterFundo();
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }
      setInterval(montarTabela, 30 * 60 * 1000);
      configurarBotaoNovo();
      ativarGlitterNosBotoes();
      adicionarAnimacaoBotoes();
    }

    // 3) GLITTER FIXO NO FUNDO
    function gerarGlitterFundo() {
      const quantidade = 40;
      for (let i = 0; i < quantidade; i++) {
        const sparkle = document.createElement("div");
        sparkle.classList.add("gold-glitter");
        sparkle.style.left = Math.random() * 100 + "vw";
        sparkle.style.top = Math.random() * 100 + "vh";
        sparkle.style.animationDelay = Math.random() * 3 + "s";
        document.body.appendChild(sparkle);
      }
    }

    // 4) CRUD E LOCALSTORAGE
    const STORAGE_KEY = "produtos-loja";

    function carregarProdutos() {
      const dados = localStorage.getItem(STORAGE_KEY);
      return dados ? JSON.parse(dados) : [];
    }

    function salvarProdutos(lista) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
    }

    function gerarId() {
      return Date.now().toString();
    }

    function formatarData(dataISO) {
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function diasParaVencimento(dataISO) {
      const hoje = new Date();
      const dataVence = new Date(dataISO + "T00:00:00");
      const diffMs = dataVence - hoje;
      return Math.floor(diffMs / (1000 * 60 * 60 * 24));
    }

    function calcularStatus(dataISO) {
      const dias = diasParaVencimento(dataISO);
      if (dias < 0) return "Vencido";
      if (dias <= 7) return "PertoDeVencer";
      return "OK";
    }

    function notificar(titulo, corpo) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification(titulo, { body: corpo });
      } else if (Notification.permission === "default") {
        Notification.requestPermission().then(perm => {
          if (perm === "granted") {
            new Notification(titulo, { body: corpo });
          }
        });
      }
    }

    function marcarComoNotificado(lista, id) {
      return lista.map(item => {
        if (item.id === id) {
          return { ...item, notificado: true };
        }
        return item;
      });
    }

    // 5) MONTA TABELA (DESKTOP) E CARDS (MOBILE)
    function montarTabela() {
      let lista = carregarProdutos();
      const tbody = document.querySelector("#tabela-produtos tbody");
      tbody.innerHTML = "";

      const cardList = document.querySelector(".mobile-card-list");
      if (cardList) cardList.innerHTML = "";

      let contVencendo = 0;
      let contVencidos = 0;

      lista.forEach(p => {
        const status = calcularStatus(p.dataValidade);
        if (status === "PertoDeVencer") contVencendo++;
        if (status === "Vencido") contVencidos++;

        // Linha tabela (desktop)
        const tr = document.createElement("tr");
        tr.classList.add(status);
        tr.innerHTML = `
          <td>${p.nome}</td>
          <td>${p.quantidade}</td>
          <td>${formatarData(p.dataValidade)}</td>
          <td>${status === "PertoDeVencer" ? "Perto de vencer" : status}</td>
          <td>
            <button class="btn-editar" data-id="${p.id}">✏️</button>
            <button class="btn-excluir" data-id="${p.id}">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);

        // Card produto (mobile)
        if (cardList) {
          const card = document.createElement("div");
          card.classList.add("mobile-card");
          card.innerHTML = `
            <div class="card-row">
              <span class="label">Nome:</span> <span>${p.nome}</span>
            </div>
            <div class="card-row">
              <span class="label">Qtd.:</span> <span>${p.quantidade}</span>
            </div>
            <div class="card-row">
              <span class="label">Validade:</span> <span>${formatarData(p.dataValidade)}</span>
            </div>
            <div class="card-row">
              <span class="label">Status:</span> <span>${status === "PertoDeVencer" ? "Perto de vencer" : status}</span>
            </div>
            <div class="card-actions">
              <button class="edit" data-id="${p.id}">✏️</button>
              <button class="delete" data-id="${p.id}">🗑️</button>
            </div>
          `;
          cardList.appendChild(card);
        }

        // Notificação se necessário
        if (status === "PertoDeVencer" && !p.notificado) {
          notificar(
            "🐱 Produto perto do vencimento",
            `O produto "${p.nome}" vence em ${formatarData(p.dataValidade)}.`
          );
          lista = marcarComoNotificado(lista, p.id);
        }
      });

      document.getElementById("avisoVencendo").textContent = contVencendo;
      document.getElementById("avisoVencido").textContent = contVencidos;

      salvarProdutos(lista);

      // Configura ações nos cards mobile
      if (cardList) {
        cardList.querySelectorAll(".edit").forEach(btn => {
          btn.addEventListener("click", e => {
            spawnGlitter(e);
            const id = btn.dataset.id;
            window.location.href = `novo.html?id=${id}`;
          });
        });
        cardList.querySelectorAll(".delete").forEach(btn => {
          btn.addEventListener("click", e => {
            spawnGlitter(e);
            const id = btn.dataset.id;
            if (confirm("Deseja realmente excluir este produto?")) {
              const novaLista = carregarProdutos().filter(item => item.id !== id);
              salvarProdutos(novaLista);
              montarTabela();
            }
          });
        });
      }

      // Configura ações na tabela desktop
      document.querySelectorAll(".btn-excluir").forEach(btn => {
        btn.addEventListener("click", e => {
          spawnGlitter(e);
          const id = btn.dataset.id;
          if (confirm("Deseja realmente excluir este produto?")) {
            const novaLista = carregarProdutos().filter(item => item.id !== id);
            salvarProdutos(novaLista);
            montarTabela();
          }
        });
      });
      document.querySelectorAll(".btn-editar").forEach(btn => {
        btn.addEventListener("click", e => {
          spawnGlitter(e);
          const id = btn.dataset.id;
          window.location.href = `novo.html?id=${id}`;
        });
      });
    }

    // 6) BOTÃO "+ NOVO PRODUTO"
    function configurarBotaoNovo() {
      const btnNovo = document.getElementById("btn-novo");
      if (btnNovo) {
        btnNovo.addEventListener("click", e => {
          spawnGlitter(e);
          window.location.href = "novo.html";
        });
      }
    }

    // 7) GLITTER DOURADO EM CLIQUE DE BOTÕES
    function spawnGlitter(event) {
      const rect = event.target.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      for (let i = 0; i < 20; i++) {
        const glitter = document.createElement("div");
        glitter.classList.add("gold-glitter");
        glitter.style.left = `${centerX}px`;
        glitter.style.top = `${centerY}px`;

        const angle = Math.random() * 2 * Math.PI;
        const distance = Math.random() * 80 + 20;
        const dx = Math.cos(angle) * distance;
        const dy = Math.sin(angle) * distance;

        glitter.style.setProperty("--dx", `${dx.toFixed(1)}px`);
        glitter.style.setProperty("--dy", `${dy.toFixed(1)}px`);

        document.body.appendChild(glitter);
        glitter.addEventListener("animationend", () => {
          glitter.remove();
        });
      }
    }

    function ativarGlitterNosBotoes() {
      document.body.addEventListener("click", e => {
        if (e.target.tagName.toLowerCase() === "button") {
          spawnGlitter(e);
        }
      });
    }

    // 8) ANIMAÇÃO “PULSE” EM BOTÕES AO PASSAR O MOUSE
    function adicionarAnimacaoBotoes() {
      document.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("mouseenter", () => {
          btn.classList.add("btn-hover");
        });
        btn.addEventListener("mouseleave", () => {
          btn.classList.remove("btn-hover");
        });
      });
    }

    // 9) PATINHA APARECE AO CLICAR EM QUALQUER LUGAR (EXCETO BOTÕES)
    function spawnClickPaw(event) {
      if (event.target.tagName.toLowerCase() === "button") return;

      const x = event.clientX;
      const y = event.clientY;
      const span = document.createElement("span");
      span.classList.add("click-paw");
      span.textContent = "🐾";
      span.style.left = `${x - 12}px`;
      span.style.top = `${y - 12}px`;
      document.body.appendChild(span);
      span.addEventListener("animationend", () => {
        span.remove();
      });
    }
  </script>
</body>
</html>
